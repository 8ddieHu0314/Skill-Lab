# v0.3.0: Trace Analysis & Extended Runtimes

**Status:** Planned

## Overview

YAML-driven trace check system for validating execution behavior, plus expanded runtime support and test definition formats.

## Features

### Trace Analysis
- 5 trace check types: command_presence, file_creation, event_sequence, loop_detection, efficiency
- YAML-defined checks per skill
- TraceCheckRegistry with @register_trace_handler decorator

### Carried from v0.2.0
- Codex CLI runtime adapter
- Given/When/Then DSL test format (`tests/scenarios.yaml`)

## CLI Commands

```bash
# Trace evaluation
sklab eval-trace ./my-skill --trace ./execution.jsonl

# Trigger testing with runtime selection
sklab trigger ./my-skill --runtime codex    # Use Codex CLI
sklab trigger ./my-skill --runtime claude   # Use Claude CLI (default)
```

## Trace Check Definition

```yaml
# tests/trace_checks.yaml
checks:
  - id: npm-install-ran
    type: command_presence
    pattern: "npm install"

  - id: package-json-created
    type: file_creation
    path: "package.json"

  - id: correct-sequence
    type: event_sequence
    sequence: ["npm init", "npm install", "npm run build"]

  - id: no-excessive-retries
    type: loop_detection
    max_retries: 3

  - id: command-count-limit
    type: efficiency
    max_commands: 20
```

## Given/When/Then DSL Test Format

Advanced trigger test definition with structured scenarios (`tests/scenarios.yaml`):

```yaml
skill: my-skill
scenarios:
  - name: "Direct invocation"
    given:
      - skill: my-skill
      - runtime: codex
    when:
      - prompt: "$my-skill do something"
      - trigger_type: explicit
    then:
      - skill_triggered: true
      - exit_code: 0

  - name: "Implicit scenario"
    given:
      - skill: my-skill
    when:
      - prompt: "I need to scaffold a new React application"
      - trigger_type: implicit
    then:
      - skill_triggered: true
      - commands_include: ["npm init"]
```

## Architecture

```
src/skill_lab/
├── tracechecks/
│   ├── registry.py             # TraceCheckRegistry
│   ├── trace_check_loader.py   # YAML loader
│   └── handlers/               # Check implementations
│       ├── command_presence.py
│       ├── file_creation.py
│       ├── event_sequence.py
│       ├── loop_detection.py
│       └── efficiency.py
├── parsers/
│   └── trace_parser.py         # JSONL parser
└── evaluators/
    └── trace_evaluator.py      # Orchestrator
```

## Deliverables

### Trace Analysis
- [ ] TraceCheckDefinition, TraceCheckResult, TraceReport models
- [ ] JSONL trace parser
- [ ] TraceCheckRegistry with @register_trace_handler
- [ ] 5 trace check handlers
- [ ] TraceEvaluator orchestrator
- [ ] CLI command: `sklab eval-trace` (unhide)

### Extended Runtimes & Test Formats
- [ ] Codex CLI runtime adapter (full implementation)
- [ ] Given/When/Then DSL test loader (`tests/scenarios.yaml`)
- [ ] Runtime selection via `--runtime` flag

## Verification

```bash
# Trace analysis tests
pytest tests/test_trace_evaluator.py -v
pytest tests/test_trace_handlers.py -v

# Runtime tests
pytest tests/test_runtimes.py -v

# Manual testing
sklab eval-trace ./my-skill --trace ./execution.jsonl
sklab trigger ./my-skill --runtime codex
```
