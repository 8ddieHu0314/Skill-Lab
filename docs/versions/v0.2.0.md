# v0.2.0: Trigger Testing

**Status:** In Progress

## Overview

Test whether skills activate correctly by sending real prompts to LLMs and analyzing execution traces.

## Features

- 4 trigger test types: explicit, implicit, contextual, negative
- Claude CLI runtime adapter (Codex CLI deferred to v0.3.0)
- Simple YAML test definition format
- Trace analysis for skill invocation detection
- Progress spinner showing current test during execution

## Trigger Test Types

| Type | Description | Example |
|------|-------------|---------|
| **Explicit** | Skill named directly with $ prefix | `$create-react-app for a todo list` |
| **Implicit** | Describes exact scenario without naming skill | `I need to scaffold a new React application` |
| **Contextual** | Realistic noisy prompt with domain context | `Building a dashboard, can you set up React?` |
| **Negative** | Should NOT trigger (catches false positives) | `How do I fix this useState hook?` |

## CLI Commands

```bash
sklab trigger ./my-skill                    # Run all trigger tests (uses Claude CLI)
sklab trigger ./my-skill -t explicit        # Filter by trigger type
sklab trigger ./my-skill -f json            # Output as JSON
sklab trigger ./my-skill -o results.json    # Save JSON to file

# Global flags
sklab -v                                    # Show version
sklab -h                                    # Show help
sklab trigger -h                            # Show trigger command help
```

## Prerequisites

Trigger testing requires:
- **Claude CLI**: Install via `npm install -g @anthropic-ai/claude-code`

> **Note:** Codex CLI support is planned for v0.3.0.

## Test Definition Format

Tests are defined in `tests/triggers.yaml`:

```yaml
skill: my-skill
test_cases:
  - id: explicit-1
    name: "Direct skill invocation"
    type: explicit
    prompt: "$my-skill do something"
    expected: trigger

  - id: implicit-1
    name: "Scenario description"
    type: implicit
    prompt: "I need to scaffold a new React application"
    expected: trigger

  - id: negative-1
    name: "Should not trigger"
    type: negative
    prompt: "How do I fix this useState hook?"
    expected: no_trigger
```

### Test Case Fields

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique identifier for the test |
| `name` | No | Human-readable test name |
| `type` | Yes | Trigger type: explicit, implicit, contextual, negative |
| `prompt` | Yes | The prompt to send to the LLM |
| `expected` | Yes | Expected result: `trigger` or `no_trigger` |

> **Note:** Given/When/Then DSL format (`tests/scenarios.yaml`) is planned for v0.3.0.

## Architecture

```
src/skill_lab/
├── triggers/
│   ├── test_loader.py         # YAML test loading
│   ├── trigger_evaluator.py   # Orchestrates tests (with progress callback)
│   └── trace_analyzer.py      # Skill invocation detection
└── runtimes/
    ├── base.py                # RuntimeAdapter ABC
    ├── codex_runtime.py       # Codex CLI adapter (stub, v0.3.0)
    └── claude_runtime.py      # Claude CLI adapter
```

## Important Note: Execution Environment

**Commands execute on the user's local machine**, not in a sandbox. Skills can:
- Install packages (`npm install`, `pip install`)
- Create, modify, delete files
- Run arbitrary shell commands

Docker sandboxing is planned for v0.4.0.

## Deliverables

- [x] TriggerTestCase, TriggerResult, TriggerReport models
- [x] YAML test case loader (simple format)
- [x] RuntimeAdapter abstract base class
- [x] Claude CLI runtime adapter
- [x] TraceAnalyzer for skill invocation detection
- [x] TriggerEvaluator orchestrator
- [x] CLI command: `sklab trigger`
- [x] Progress spinner with current test display
- [x] CLI flags: `-v`/`--version`, `-h`/`--help`
- [ ] Documentation updates
- [ ] Release to PyPI

### Deferred to v0.3.0

- [ ] Codex CLI runtime adapter
- [ ] Given/When/Then DSL format (`tests/scenarios.yaml`)
- [ ] `sklab eval-trace` command (hidden in v0.2.0)

## Verification

```bash
# Unit tests
pytest tests/test_triggers.py -v
pytest tests/test_runtimes.py -v

# Manual testing (requires Claude CLI installed)
sklab trigger ./tests/fixtures/skills/testing-features
```
